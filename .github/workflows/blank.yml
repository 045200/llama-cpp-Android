name: Build llama.cpp for Android arm64

on:
  schedule:
    - cron: '0 */12 * * *'   # 每12小时
  workflow_dispatch:

env:
  LLAMA_REPO: ggerganov/llama.cpp
  NDK_VERSION: r26d
  ANDROID_ABI: arm64-v8a
  ANDROID_PLATFORM: 23
  BUILD_TYPE: Release

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      skip_build: ${{ steps.check-release.outputs.skip_build }}
      latest_tag: ${{ steps.get-latest-tag.outputs.latest_tag }}
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Get latest release tag from llama.cpp
        id: get-latest-tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          LATEST_TAG=""
          
          # 方法1: 通过 GitHub CLI 获取最新的正式 release
          echo "Attempt 1: Fetch latest release via gh CLI..."
          LATEST_TAG=$(gh release view --repo ${{ env.LLAMA_REPO }} --json tagName --jq .tagName 2>/dev/null || true)
          if [ -n "$LATEST_TAG" ] && [ "$LATEST_TAG" != "null" ]; then
            echo "Found latest release tag: $LATEST_TAG"
            echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 方法2: 使用 API 获取最新 release（作为备选）
          echo "Attempt 2: Fetch latest release via API..."
          LATEST_TAG=$(curl -s -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/${{ env.LLAMA_REPO }}/releases/latest" | jq -r .tag_name)
          if [ -n "$LATEST_TAG" ] && [ "$LATEST_TAG" != "null" ]; then
            echo "Found latest release tag via API: $LATEST_TAG"
            echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 方法3: 从 Git 标签获取最新版本（按版本排序）
          echo "Attempt 3: Fetch tags via git ls-remote..."
          TAGS=$(git ls-remote --tags https://github.com/${{ env.LLAMA_REPO }}.git | awk '{print $2}' | sed 's|refs/tags/||' | sed 's/\^{}//' | sort -u -V)
          if [ -n "$TAGS" ]; then
            LATEST_TAG=$(echo "$TAGS" | tail -n1)
            echo "Found latest tag via git: $LATEST_TAG"
            echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Failed to fetch latest tag using all methods."
          echo "latest_tag=" >> $GITHUB_OUTPUT

      - name: Check if release already exists or tag missing
        id: check-release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST_TAG="${{ steps.get-latest-tag.outputs.latest_tag }}"
          if [ -z "$LATEST_TAG" ]; then
            echo "No valid upstream tag found. Skipping build."
            echo "skip_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          TAG="android-$LATEST_TAG"
          if gh release view "$TAG" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "Release $TAG already exists. Skipping build."
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "No existing release found for $TAG. Proceeding with build."
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-and-build
    if: needs.check-and-build.outputs.skip_build == 'false' && needs.check-and-build.outputs.latest_tag != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository (for release step)
        uses: actions/checkout@v4

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          add-to-path: false

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Checkout llama.cpp source at tag
        uses: actions/checkout@v4
        with:
          repository: ${{ env.LLAMA_REPO }}
          ref: ${{ needs.check-and-build.outputs.latest_tag }}
          path: llama.cpp
          fetch-depth: 1

      - name: Configure CMake for Android
        working-directory: llama.cpp
        run: |
          cmake -B build \
            -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ env.ANDROID_ABI }} \
            -DANDROID_PLATFORM=android-${{ env.ANDROID_PLATFORM }} \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_MAKE_PROGRAM=ninja \
            -GNinja \
            -DLLAMA_BUILD_TESTS=OFF

      - name: Build
        working-directory: llama.cpp
        run: |
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel $(nproc)

      - name: Package binaries
        run: |
          cd llama.cpp/build/bin
          tar -czf ../../../llama-cpp-android-${{ needs.check-and-build.outputs.latest_tag }}-arm64.tar.gz *
          cd ../../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: llama-cpp-android-${{ needs.check-and-build.outputs.latest_tag }}-arm64
          path: llama-cpp-android-${{ needs.check-and-build.outputs.latest_tag }}-arm64.tar.gz

      - name: Create GitHub Release and upload asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="android-${{ needs.check-and-build.outputs.latest_tag }}"
          gh release create "$TAG" \
            --title "Android arm64 build for llama.cpp ${{ needs.check-and-build.outputs.latest_tag }}" \
            --notes "Automated build of llama.cpp ${{ needs.check-and-build.outputs.latest_tag }} for Android arm64-v8a." \
            llama-cpp-android-${{ needs.check-and-build.outputs.latest_tag }}-arm64.tar.gz
