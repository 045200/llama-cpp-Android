name: Build llama-server (Android) and Upload to Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write  # 允许创建/更新 release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout llama.cpp
        uses: actions/checkout@v4
        with:
          repository: ggerganov/llama.cpp
          ref: master  # 可改为特定标签或分支

      - name: Set up NDK (r27)
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27
          add-to-path: false

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Configure CMake for Android (arm64-v8a, shared libs, API 31)
        run: |
          mkdir -p build
          cmake -B build \
            -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-31 \
            -DGGML_SHARED=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_FLAGS="-march=armv8.4a+dotprod -D_GNU_SOURCE" \
            -DCMAKE_CXX_FLAGS="-march=armv8.4a+dotprod -D_GNU_SOURCE" \
            -GNinja

      - name: Build llama-server
        run: |
          cmake --build build --target llama-server --config Release -j $(nproc)

      # 使用 find 命令查找 libomp.so（解决路径不确定问题）
      - name: Copy libomp.so from NDK
        run: |
          NDK_PATH="${{ steps.setup-ndk.outputs.ndk-path }}"
          LIBOMP_PATH=$(find "$NDK_PATH" -name "libomp.so" -path "*/aarch64/*" | head -n1)
          if [ -n "$LIBOMP_PATH" ]; then
            cp "$LIBOMP_PATH" build/bin/
            echo "Copied libomp.so from $LIBOMP_PATH"
          else
            echo "::error::libomp.so not found in NDK path: $NDK_PATH"
            exit 1
          fi

      # 打包编译产物（llama-server 和所有 .so）
      - name: Package artifacts
        run: |
          cd build/bin
          zip ../../llama-server-android.zip llama-server *.so
          cd ../..
          echo "PACKAGE_PATH=$(realpath llama-server-android.zip)" >> $GITHUB_ENV

      # 上传到 GitHub Release（固定 tag 为 llama-server-android，覆盖旧资产）
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: llama-server-android       # 固定 tag，每次都会覆盖该 release
          name: llama-server Android Build     # release 显示名称
          body: |
            ###### 自动构建的 llama-server Android 版本
            - 构建时间：${{ github.event.repository.updated_at }}
            - 提交哈希：${{ github.sha }}
            - ABI：arm64-v8a（支持 Android API 31+）
            - 包含库：libggml.so, libggml-base.so, libggml-cpu.so, libllama.so, libmtmd.so, libomp.so
          files: ${{ env.PACKAGE_PATH }}
          fail_on_unmatched_files: true
          overwrite: true                      # 覆盖同名 release 中的旧资产
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}